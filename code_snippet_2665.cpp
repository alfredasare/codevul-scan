Here's the fixed version of the code that addresses the Confused Deputy problem (CWE-119) and the potential privilege escalation vulnerability (CVE-2014-4